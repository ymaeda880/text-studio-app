# -*- coding: utf-8 -*-
# lib/proofreading/explanation.py
#
# 校正方針（ページ/行/理由テーブル）ロジックの利用者向け説明（Streamlit用）

from __future__ import annotations
import streamlit as st


def render_proof_policy_logic_expander() -> None:
    """
    「校正方針（ページ/行/理由）の解析ロジック」と
    「AI校正に関する注意点」を説明する expander を描画する。
    pages/10_校正.py などから呼び出して使う。
    """
    with st.expander("ℹ️ 校正方針の解析ロジックとAI利用上の注意（クリックで開く）", expanded=False):
        st.markdown(
            """
            ### 1. このアプリの目的

            - 文章そのものを書き換えるのではなく，**「どのページのどの行を，どのような理由で直すとよいか」** という **校正方針（チェックリスト）** を作ることを目的としています．
            - 出力されるのは，頁・行・重要度・原文・修正案・理由などをまとめた **Markdown形式の表** です．最終的な原稿の修正は，利用者ご自身が Word 等で行ってください．

            ---

            ### 2. テキストの扱いと行番号の付け方

            - 入力は，**貼り付けテキスト** または **.docx / .txt / テキスト層付き .pdf** に対応しています．
            - 画像だけのPDF（テキスト層なし）は対象外です．その場合は，事前にOCRでテキスト化してください．
            - 読み込んだテキストは改行ごとに分割し，  
              `ページ行数（例：40行）` に基づいて  
              `\[ページ:行\]` 形式（例：`[1:01]`）の行番号を付けてプレビュー表示します．
            - この行番号は，校正方針の表に出てくる **「頁」「行」** と対応します（印刷レイアウトではなく，あくまで擬似的なページ割りです）．

            ---

            ### 3. 校正方針テーブルの生成ロジック

            - 解析モード（通常校正・厳格校正など）を選択すると，  
              そのモードに応じた **Systemプロンプト** を組み立てて AI に渡します．
            - 必要に応じて「追加プロンプト」を指定することで，  
              外来語の扱い・固有名詞の扱い・文体などの方針を補足できます．
            - テキストはページごとに分割され，各ページについて AI が  
              次のような列を持つ **Markdown形式の表** を生成します：
              - 頁
              - 行
              - 重要度
              - 原文
              - 修正案
              - 理由
            - すべてのページ分の表を連結し，アプリ内に Markdown として表示します．

            ---

            ### 4. レポート（PDF / Word）の出力

            - 解析が終わると，次の内容を含む **レポート** を作成できます：
              - 原文（行番号つきプレビュー）
              - 校正方針（AIが生成したMarkdown表）
            - 出力形式は次のいずれかを選択できます：
              - PDF（.pdf）
              - Word（.docx）  
            - PDF版では，原文は 1行1行をテーブル表示し，校正方針は Markdown表をパースした表として整形して出力します．
            - Word版では，原文および校正方針を **そのままテキストとして貼り込んだレポート** を生成します．

            ---

            ### 5. AI校正に関する重要な注意事項

            このアプリの校正方針は，OpenAI の生成AI（大規模言語モデル）によって自動生成された  
            **「AIの提案」** であり，「正解」や「公式見解」ではありません．  
            以下の点にご注意ください：

            - **提案はあくまで AI の意見であり，常に正しいとは限りません。**
              - 文法・用語・専門内容などについて誤った判断をする可能性があります．
              - 組織固有の表記ルールや業界慣行と合わない提案が出ることもあります．
            - **文脈を誤解したり，見当違いの修正案・理由を出す場合があります。**
              - 本来問題のない表現を「誤り」と判断したり，
                逆に明らかな問題を見落とすこともあります．
            - **同じ原稿を同じ設定で解析しても，結果が毎回同じになるとは限りません。**
              - 生成AIは確率的に動作するため，解析を **複数回行うと表の内容が少しずつ変わる** 場合があります．
              - 気になる箇所は，モードや追加プロンプトを変えつつ，複数回解析して比較することも有効です．
            - **最終的な採否の判断と責任は，利用者にあります。**
              - 提案された修正案をそのまま採用するのではなく，必ずご自身の目で内容を確認し，  
                文脈・意図・専門性の観点から妥当かどうか判断してください．
              - 公的文書，契約書，論文，評価書など，結果に重大な影響が出る文書では，  
                必ず人間による最終チェックを行ってください．

            ---

            ### 6. 個人情報・機密情報とセキュリティ

            - このアプリでは，校正方針の解析に **OpenAI の GPT API** を使用しており，  
              入力されたテキストはサーバーから OpenAI の API エンドポイントに送信されます．
            - OpenAI 側では，API やビジネス向け製品に対して
              - 通信経路の暗号化（TLS 1.2 以上）
              - データの暗号化保存（AES-256 などによる暗号化）  
              といった **業界標準レベルの暗号化** が行われています．
            - OpenAI のビジネス向け製品および API プラットフォームは，  
              **SOC 2 Type 2** に基づく監査を受けており，  
              さらに **ISO/IEC 27001 / 27017 / 27018 / 27701** といった  
              情報セキュリティ・クラウドセキュリティ・プライバシー保護に関する  
              国際規格にも準拠した運用が行われています．
            - また，OpenAI のデータ保護体制は，GDPR・CCPA などの  
              プライバシー関連法令への準拠を支援するよう設計されています．
            - ただし，本アプリ側で **自動的に完全な匿名化処理が行われるわけではありません**．  
              個人名と住所など，機密性の高い情報が含まれる場合は，
              可能な範囲でマスキング・置き換えを行ってからご利用いただくことを推奨します．

            ---

            ### 7. 想定している使い方

            - このアプリは，「どこを優先的に見直すべきか」「どういう観点で直すとよいか」を  
              **一覧化するための補助ツール** として設計されています．
            - AI が示した内容を **ヒント** として活用しつつ，最終的な文章表現は  
              利用者ご自身の判断で整えていただくことを前提としています．
            """
        )
