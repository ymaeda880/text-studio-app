# -*- coding: utf-8 -*-
# lib/proofreading/explanation.py
#
# 校正方針（ページ/行/理由テーブル）ロジックの利用者向け説明（Streamlit用）

from __future__ import annotations
import streamlit as st

# ============================================================
# ✅ 文言定数（編集は基本ここだけ）
# ============================================================

HELP_EXPANDER_TITLE = "📌 説明（クリックで展開）"
HELP_TABS = ["最初に", "校正モード", "ロジック/注意", "inbox対応"]

# ============================================================
# ✅ 説明（最初に）
# ============================================================

INTRO_CAPTION = (
    "数段落程度の文章を貼り付けて，解析のボタンを押してください．"
    "解析には少し時間がかかります．"
    "校正にはAIを使用していますので，個人情報や機密文書の取り扱いには注意してください。"
)

INTRO_TEXT = """本文を入力して ① 解析 を実行すると，
/行/理由つきの校正方針（Markdown表）を生成します。
文章は， 1,000行以内 に区切って校正をかけることを推奨します．
通常校正，厳格校正，簡易校正の３種類があります．
解析モードを変更することで校正の程度を選択できます．"""

INTRO_TABLE_NOTE = "Wordの図表を貼り付けた時は，解析モードで 図表校正 を選択してください．"

INTRO_WORD_WORKFLOW_HTML = """
<div style="line-height:1.6">
  <span style="color:red; font-size:18px; font-weight:bold;">
    Wordファイルに校正をかけたい
  </span>
  ときは，まず <b>word解析</b> を行い， <b>中間テキスト</b> を作成してください．
  その中間テキストをこの <b>校正</b> の <b>「ファイルから」タブ</b> より，
  （雲のマークの上に）ドロップしてください．または，
  <b>「貼り付けテキスト」タブ</b> にペーストしてください．
  その際に <b>解析モード</b> は
  <span style="color:red; font-size:18px; font-weight:bold;">解析文書校正</span>
  を選択してください．
  文章は，<b>1,000行以内</b> になるように分割して校正することを推奨します．
  <br>
  ※ 将来的には，Wordファイルを直接校正できるように改善する予定です．
  <br><br>
</div>
"""

# ============================================================
# ✅ 説明（校正モード）
# ============================================================

MODES_MD = """
### 校正モードの使い方

以下の3つの方法で校正を行えます．

1. **テキストの校正**
   - サイドメニューから **「校正」** を選択します．
   - 書類からテキストをコピーし，**「貼り付けテキスト」** の欄に貼り付けます．
   - 解析モードで **「通常校正」** を選択し，**「解析」** ボタンを押して校正を実行します．

2. **表の校正**
   - サイドメニューから **「校正」** を選択します．
   - 書類から表をコピーし，**「貼り付けテキスト」** の欄に貼り付けます．
   - 解析モードで **「図表校正」** を選択し，**「解析」** ボタンを押して校正を実行します．

3. **Word解析＋校正**
   - サイドメニューから **「word解析」** を選択します．
   - Word書類をアップロードして **「中間ファイル」** を作成します．
   - 続いて，サイドメニューから **「校正」** を選択します．
   - **「ファイルから」** タブを選択し，解析モードで **「解析文書校正（通常校正）」** を選びます．
   - 先ほど作成した **「中間ファイル」** をドラッグ＆ドロップし，**「解析」** ボタンを押して校正を実行します．

---

報告書の1章分をまとめて校正すると，処理に時間がかかる場合があります．
いくつかに分割して校正することをおすすめします．
**1回の校正は最大50頁程度を目安** にしてください．

それでも時間がかかることがありますが，右上のアイコンが動いている間は
AI が処理中です（フリーズではありません）．
コーヒーでも飲みながら，ゆっくりお待ちください．
"""

# ============================================================
# ✅ 説明（ロジック/注意）
# ============================================================

LOGIC_MD = """
### 1. このアプリの目的

- 文章そのものを書き換えるのではなく，**「どのページのどの行を，どのような理由で直すとよいか」** という **校正方針（チェックリスト）** を作ることを目的としています．
- 出力されるのは，頁・行・重要度・原文・修正案・理由などをまとめた **Markdown形式の表** です．最終的な原稿の修正は，利用者ご自身が Word 等で行ってください．

---

### 2. テキストの扱いと行番号の付け方

- 入力は，**貼り付けテキスト** または **.docx / .txt / テキスト層付き .pdf** に対応しています．
- 画像だけのPDF（テキスト層なし）は対象外です．その場合は，事前にOCRでテキスト化してください．
- 読み込んだテキストは改行ごとに分割し，
  `ページ行数（例：40行）` に基づいて
  `\\[ページ:行\\]` 形式（例：`[1:01]`）の行番号を付けてプレビュー表示します．
- この行番号は，校正方針の表に出てくる **「頁」「行」** と対応します（印刷レイアウトではなく，あくまで擬似的なページ割りです）．

---

### 3. 校正方針テーブルの生成ロジック

- 解析モード（通常校正・厳格校正など）を選択すると，そのモードに応じた **Systemプロンプト** を組み立てて AI に渡します．
- 必要に応じて「追加プロンプト」を指定することで，外来語の扱い・固有名詞の扱い・文体などの方針を補足できます．
- テキストはページごとに分割され，各ページについて AI が次のような列を持つ **Markdown形式の表** を生成します：
  - 頁
  - 行
  - 重要度
  - 原文
  - 修正案
  - 理由
- すべてのページ分の表を連結し，アプリ内に Markdown として表示します．

---

### 4. レポート（PDF / Word）の出力

- 解析が終わると，次の内容を含む **レポート** を作成できます：
  - 原文（行番号つきプレビュー）
  - 校正方針（AIが生成したMarkdown表）
- 出力形式は次のいずれかを選択できます：
  - PDF（.pdf）
  - Word（.docx）
- PDF版では，原文は 1行1行をテーブル表示し，校正方針は Markdown表をパースした表として整形して出力します．
- Word版では，原文および校正方針を **そのままテキストとして貼り込んだレポート** を生成します．

---

### 5. AI校正に関する重要な注意事項

このアプリの校正方針は，OpenAI の生成AI（大規模言語モデル）によって自動生成された
**「AIの提案」** であり，「正解」や「公式見解」ではありません．
以下の点にご注意ください：

- **提案はあくまで AI の意見であり，常に正しいとは限りません。**
  - 文法・用語・専門内容などについて誤った判断をする可能性があります．
  - 組織固有の表記ルールや業界慣行と合わない提案が出ることもあります．
- **文脈を誤解したり，見当違いの修正案・理由を出す場合があります。**
  - 本来問題のない表現を「誤り」と判断したり，
    逆に明らかな問題を見落とすこともあります．
- **同じ原稿を同じ設定で解析しても，結果が毎回同じになるとは限りません。**
  - 生成AIは確率的に動作するため，解析を **複数回行うと表の内容が少しずつ変わる** 場合があります．
  - 気になる箇所は，モードや追加プロンプトを変えつつ，複数回解析して比較することも有効です．
- **最終的な採否の判断と責任は，利用者にあります。**
  - 提案された修正案をそのまま採用するのではなく，必ずご自身の目で内容を確認し，
    文脈・意図・専門性の観点から妥当かどうか判断してください．
  - 公的文書，契約書，論文，評価書など，結果に重大な影響が出る文書では，
    必ず人間による最終チェックを行ってください．

---

### 6. 個人情報・機密情報とセキュリティ

- このアプリでは，校正方針の解析に **OpenAI の GPT API** を使用しており，
  入力されたテキストはサーバーから OpenAI の API エンドポイントに送信されます．
- ただし，本アプリ側で **自動的に完全な匿名化処理が行われるわけではありません**．
  個人名と住所など，機密性の高い情報が含まれる場合は，
  可能な範囲でマスキング・置き換えを行ってからご利用いただくことを推奨します．

---

### 7. 想定している使い方

- このアプリは，「どこを優先的に見直すべきか」「どういう観点で直すとよいか」を
  **一覧化するための補助ツール** として設計されています．
- AI が示した内容を **ヒント** として活用しつつ，最終的な文章表現は
  利用者ご自身の判断で整えていただくことを前提としています．
"""

# ============================================================
# ✅ 説明（inbox対応） ※ユーザー向けの使用法（今の説明に差し替え）
# ============================================================

INBOX_MD = """
### 📥 Inbox対応の使い方（ファイルから校正）

この校正ページは，貼り付けだけでなく **Inbox（ファイル置き場）に入れたテキスト**を選んで校正できます．  
コピー＆ペーストだと崩れる場合や，ファイルで管理したい場合に便利です．

---

#### 1. 事前準備：Inboxにファイルを入れる

- 校正したい **テキストファイル（kind=text）** を Inbox に格納します（例：.txt）．  
  ※このページの「Inboxから」は **textのみ** を対象にしています．

---

#### 2. 校正ページで「📥 Inboxから」を選ぶ

画面の入力方法で **「📥 Inboxから」** を選択します．  
Inboxの一覧（textのみ）が表示されます．

---

#### 3. 対象ファイルを選ぶ（読み込み）

一覧からファイルを選ぶと読み込みが完了し，画面に

- ✅ Inbox から読み込みました（選択結果を保持しました）

と表示されます．  
※画面が更新されても選択が消えにくいように，選択結果を保持する設計です．

---

#### 4. 「① 解析（Inbox）」を押して解析開始

- 右側の **「① 解析（Inbox）」** を押すと解析が始まります．
- 解析の前に，サイドバーで **解析モード** を選んでください（通常校正 / 厳格校正 / 図表校正 など）．
- word解析の結果作成されたテキストファイルを校正するときは，「解析文書（標準）校正（通常校正）」を選んください．
この設定はデフォルトになっていますので，特に選択しなければ，このモードになっています．

---

#### 5. 結果の確認と保存

解析が終わると，次が表示されます：

- 行番号付きプレビュー
- 校正方針（ページ/行/理由の表）
- PDF / Word のダウンロード

---

#### 重要な注意（Inbox入力の仕様）

- **対象は text のみ**です（PDFやWordはこの「Inboxから」では選べません）．
- **last_viewed（最終閲覧）は更新しません**（校正用の読み込みとして扱います）．
- うまくいかないときは：
  - 「保持中 まだ選択されていません」と出ていないか
  - ファイルが空でないか（0文字ではないか）
  を確認してください．
"""

# ============================================================
# ✅ 新API：説明UIを 1つに統合（expander + 4 tabs）
# ============================================================

def render_proofreading_help_expander() -> None:
    """
    説明UIを 1つの expander に統合し、tabs で切り替える。
    - 純粋な表示専用（状態・ロジックなし）
    - pages 側では 1 行呼ぶだけ
    """
    with st.expander(HELP_EXPANDER_TITLE, expanded=False):
        tab_intro, tab_modes, tab_logic, tab_inbox = st.tabs(HELP_TABS)

        with tab_intro:
            _render_tab_intro()

        with tab_modes:
            _render_tab_modes()

        with tab_logic:
            _render_tab_logic()

        with tab_inbox:
            _render_tab_inbox()

# ============================================================
# タブ描画（表示だけ）
# ============================================================

def _render_tab_intro() -> None:
    st.caption(INTRO_CAPTION)
    st.write(INTRO_TEXT)
    st.write(INTRO_TABLE_NOTE)
    st.markdown(INTRO_WORD_WORKFLOW_HTML, unsafe_allow_html=True)


def _render_tab_modes() -> None:
    st.markdown(MODES_MD)


def _render_tab_logic() -> None:
    st.markdown(LOGIC_MD)


def _render_tab_inbox() -> None:
    st.markdown(INBOX_MD)
