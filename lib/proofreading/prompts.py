# -*- coding: utf-8 -*-
# lib/proofreading/prompts.py
#
# 校正用ページで共通利用するプロンプト定義・組み立てロジック

from __future__ import annotations
from typing import Dict

# ------------------------------------------------------------
# モード定義（解析のみ使用）
# ------------------------------------------------------------
MODE_DEFS: Dict[str, Dict[str, str]] = {
    "厳格校正": {
        "desc": "助詞・主述一致・冗長/重複・語順・誤字脱字・用語誤用・文体不統一まで広く対象。意味は変えず最適化のための方針を抽出。",
        "analyze_inst": (
            "あなたは厳密な日本語校正リーダーです。以下の番号付きテキストを読み、"
            "『何をどのように直すべきか』を、具体的な理由とともに一覧化してください。\n"
            "行頭の [page:line] を必ず参照して位置を示し、過度な意訳は避けてください。\n"
            "助詞（てにおは）、主述一致、冗長、重複、語順、誤字脱字、用語誤用、文体の不統一に特に注意。\n"
        ),
    },
    "通常校正": {
        "desc": "助詞・主述一致・語順・誤字脱字・文体不統一などを対象。意味は変えず最適化のための方針を抽出。",
        "analyze_inst": (
            "あなたは通常の日本語校正リーダーです。以下の番号付きテキストを読み、"
            "『何をどのように直すべきか』を、理由とともに一覧化してください。\n"
            "行頭の [page:line] を必ず参照して位置を示し、過度な意訳は避けてください。\n"
        ),
    },
    "簡易校正（ミス最小修正）」": {
        "desc": "明白なミスのみ（てにおは・助詞・誤字脱字・明確な変換ミス）に絞った方針を抽出。",
        "analyze_inst": (
            "あなたは日本語の軽微校正リーダーです。以下の番号付きテキストから、"
            "『明白なミス（てにおは・助詞の誤り、誤字脱字、明確な変換ミス）』のみを抽出してください。"
            "語順変更やスタイル統一などの裁量的変更は提案しないでください。"
            "「理由」 は“明白な誤り”である根拠を簡潔に。"
        ),
    },
}

# ------------------------------------------------------------
# 解析時に常に付与する共通プロンプト
# ------------------------------------------------------------
COMMON_PROMPT = (
    "【共通方針（厳守）】\n"
    "それぞれの校正の必要性を0から10までの数字で表して明記してください：\n"
    "- 必要性が高い校正には大きい数字をつけてください。\n"
    "- 誤字・脱字など，校正が必ず必要なものを10と評価してください。\n"
    "- 校正する必要の無いものを0と評価してください。\n"
    "- 出力は **Markdownの表** で、列は次の順：頁 | 行 | 重要度 | 原文 | 修正案 | 理由\n"
    "「原文」及び「修正案」は，修正に関連する箇所を，修正理由が分かるように抜粋してください。\n"
)

# ------------------------------------------------------------
# System プロンプト組み立てユーティリティ
# ------------------------------------------------------------
def get_analyze_instruction(mode: str) -> str:
    """モードに対応するベースの解析指示文を返す"""
    return MODE_DEFS.get(mode, MODE_DEFS["厳格校正"])["analyze_inst"]

def build_system_prompt(*, mode: str, extra: str = "") -> str:
    """
    モード＋追加プロンプト＋共通方針をまとめた System プロンプト文字列を返す。
    """
    base = get_analyze_instruction(mode)
    parts = [base.strip()]

    extra = (extra or "").strip()
    if extra:
        parts.append("【追加指示（厳守）】\n" + extra)

    common = (COMMON_PROMPT or "").strip()
    if common:
        parts.append(common)

    return "\n\n".join(parts)
