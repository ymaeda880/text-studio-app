# -*- coding: utf-8 -*-
# lib/chart_check/explanation.py
#
# 図表番号・タイトル照合ロジックの利用者向け説明（Streamlit用）

from __future__ import annotations
import streamlit as st


def render_numbering_logic_expander() -> None:
    """
    「図表番号・タイトルの照合ロジック」を説明する expander を描画する。
    pages/14_図表チェック.py などから呼び出して使う。
    """
    with st.expander("ℹ️ 図表番号・タイトルの照合ロジック（クリックで開く）", expanded=False):
        st.markdown(
            """
            ### 1. 図・表・図表の見出しの拾い方

            - 「図」「表」「図表」に続く番号（例：`図 3.2-1`，`表4-3（1/3）` など）を正規表現で検出しています．
            - その出現位置と行の形から **「見出し（キャプション）」** と **「本文からの参照」** を自動判定します．

            **見出し（タイトル）とみなす条件**

            - 「図／表／図表＋番号」が **行頭にある**．
            - 同じ行の中で，その直後が助詞などで始まっていない（「を」「は」「に」など）．
            - 同じ行の中に句点「。」が無い（＝一文の中の一部ではない）．

            例）  
            `図 3.1-2  鉄道駅周辺の立地状況` → 見出し（タイトル）として判定．

            **本文参照とみなす条件**

            - 行の途中に出てくる場合  
              例）`…（図3.1-2を参照）`  
            - 「図3.1-2」のすぐ後ろが「を／は／に／など」などの助詞になっている場合．  
            - 同じ行の中に句点「。」がある場合（文章の一部として使われているとみなす）．

            これらは **本文中の参照** として集計されます．

            ---

            ### 2. 図表番号の正規化（図表キーとベースキー）

            見出しと本文参照を正しく突き合わせるために，まず番号表記を次のように統一しています．  
            ここで作られるのが **図表キー** です。

            - 全角数字・全角括弧 → 半角に変換．
            - 「．」「・」「.」などのドット類 → `"."` に統一．
            - 「‐」「―」「ー」などのハイフン類 → `"-"` に統一．
            - 前後の余分な空白を削除．

            例）  
            - `図 ３．１ー２ （１／３）` → `図3.1-2(1/3)`  

            この「図3.1-2(1/3)」のような文字列を **図表キー** と呼び，
            - 見出し側（キャプション）
            - 本文参照側  
            の両方で共通のキーとして使うことで「突き合わせ」を行います．

            さらに，14_図表チェック.py では，図表キーから

            - `(... 1/3)` や `(... ２／３)` といった **分割ページ番号** を含む末尾の括弧
            - `（続き）` のような「続き」表現を含む末尾の括弧

            をまとめて取り除いた **ベースキー（`base_key`）** を使っています．

            例）  

            - `表3.1.5-1(1/3)` → ベースキー：`表3.1.5-1`  
            - `表3.1.5-1(2/3)` → ベースキー：`表3.1.5-1`  
            - `図4.2-3（続き）` → ベースキー：`図4.2-3`  

            これにより，

            - 見出しに `表3.1.5-1(1/3)` と `表3.1.5-1(2/3)` がある
            - 本文では「表3.1.5-1」とだけ書いて参照している

            といったケースでも，**同じ図表のシリーズである** とみなして突き合わせを行えるようになっています．

            ---

            ### 3. 「続きページ」の判定ロジック

            同じ図表キーについて，次のような場合は **「続きページ」** と判定し，
            真の重複とはみなしません．

            - 同じ図表キーで，PDFページが連続している（例：p10, p11, p12）．
            - 見出しタイトルの「本体部分」が同じである．  
              ※ タイトル末尾の `(ラベル 1/3)` や `（続き）` といった括弧書きは一旦取り除いて比較しています．
            - タイトル末尾に `(1/3)`，`(2/3)` などの分割番号が付いている場合，
              - 1, 2, 3 … と **番号がきちんと並んでいる** かも確認しています．

            この条件を満たすグループは「続き」とみなし，
            「続き判定」シートや画面の「続き判定」テーブルにまとめて表示します．

            ---

            ### 4. 真の重複・欠番のチェック

            図表番号の品質チェックでは，次の 2 点を確認しています．

            1. **真の重複**  
               - 同じ図表キーで，3. の「続きページ」の条件を満たさない複数の見出しがある場合，
                 「真の重複の可能性」として一覧に出します．

            2. **連番の開始番号と欠番**  
               - 「図」「表」「図表」ごとに，
                 - `4.2-1`, `4.2-2`, `4.2-3` … のような系列を取り出し，
                 - 最初の番号が **1 から始まっているか**  
                 - 間に **欠番（飛び）がないか**  
                 をチェックします．

               このとき，末尾の `(1/3)` などを落とした **ベースキー（base_key）** を使って
               系列ごとの番号列を作っています。

            これにより，

            - 「図4.2-1の次がいきなり図4.2-3になっている」
            - 「図4.2 の系列が図4.2-2から始まっている」

            といった番号のゆらぎを見つけやすくしています．

            ---

            ### 5. 見出しと本文参照の「突き合わせ」（ベースキー利用）

            見出し側と本文参照側の図表キーを比較し，次の 3 種類に分類します．  
            ここで**完全一致だけでなくベースキー一致も許容するようにした**のが，最近の変更点です。

            1. **引用されている見出し**  

               - 見出しの図表キー `k` について，
                 - 本文中に **同じ図表キー `k`** が出てくる  
                   あるいは
                 - `k` から分割括弧を落とした **ベースキー `base_key(k)`** に一致する参照がある  

               場合を「引用あり」と判定します．  
               つまり，

               - 見出し：`表3.1.5-1(1/3)`  
               - 本文：`表3.1.5-1` とだけ書いて参照

               のようなケースでも，ベースキーが同じなので **「引用されている見出し」** として扱います．

               画面上では，見出しタイトル，最初に出てくるページ，参照ページ，実際の参照テキストを 1 行にまとめて表示します．

            2. **未引用の見出し**  

               - 見出しの図表キー `k` について，
                 - 本文に `k` が一度も出てこない
                 - かつ，`base_key(k)` に一致する参照もない  

               場合を「未引用の見出し」として扱います．  
               ベースキーでかなり緩めにマッチングしているので，  
               **「本当にどこからも参照されていない可能性が高い図表」** の候補です．

               画面では「見出しページ」と「参照ページ」を並べて，引用漏れの候補として表示します．

            3. **見出しなしの参照**  

               - 本文の図表キー `k` について，
                 - 見出し側に `k` と完全一致する図表キーが無く
                 - かつ，`base_key(k)` に一致する見出しも無い  

               場合を「見出しなし参照」として扱います．  
               これは，

               - 図そのものの入れ忘れ
               - 番号の誤記（本文と見出しで番号がずれている）

               などの候補として確認していただきたい箇所です．

            画面上の

            - 「① 全ての図表見出しが本文で引用されているか？」
            - 「② 本文に参照があるが見出しが無いものはないか？」

            は，この結果をまとめたサマリーです．

            ---

            ### 6. Excel / XLSX 出力についての補足

            - 画面上のテーブルだけでなく，
              - ページ別ラベル一覧
              - 図表見出し一覧
              - 本文参照一覧
              を **CSV** としてダウンロードできます．
            - また，突き合わせ結果や重複・続き判定，連番チェックの結果をまとめた **XLSX（Excel）ファイル** も出力します．
            - XLSX では，`1-2` のような頁ラベルが日付や数式に誤変換されないよう，
              `"=\"1-2\""` 形式でセルを保護するなど，Excel側で扱いやすい形に整形しています．

            ---

            ### 7. ご利用上の注意

            - ここでの判定は，あくまで **自動ルールに基づく目安** です．
            - 日本語の言い回しやレイアウト，独自の図表番号ルールによっては，
              タイトル／参照の判定やベースキーのマッチングがずれる場合があります．
            - 特に，括弧内の表記に独自ルールがある資料では，
              「続き」や「分割番号」の扱いをご確認ください．
            - 最終的には，画面表示やダウンロードした Excel / XLSX を確認しながら，
              **人間の目でチェック** していただくことを前提としています．
            """
        )
