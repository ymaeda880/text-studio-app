# -*- coding: utf-8 -*-
# lib/style_check/explanation.py
#
# Word スタイルチェックロジックの利用者向け説明（Streamlit用）

from __future__ import annotations
import streamlit as st


def render_style_check_expander() -> None:
    """
    「Word スタイルチェック」の仕組みを説明する expander を描画する。
    pages/20_スタイルチェック.py などから呼び出して使う。
    """
    with st.expander("ℹ️ スタイルチェックの内容と判定ロジック（クリックで開く）", expanded=False):
        st.markdown(
            """
            ### 1. このチェックが行っていること

            このツールは，Word（.docx）文書の **「見た目のゆらぎ」や「スタイルの使い方の乱れ」** を機械的に洗い出し，
            修正候補の箇所に「注意」として印を付けるためのものです．  
            **「誤り」ではなく，あくまで「気を付けた方がよい可能性がある箇所」** を列挙します。

            主に次の情報を解析しています：

            - 段落ごとの **スタイル名（Normal / 見出し1 など）**
            - 段落内の **フォント名**・**フォントサイズ**
            - 文書全体で使われている **フォントの種類** と **文字数**
            - スタイル（見出し／本文）の使い方  など

            これらをもとに，「ベースとなる本文フォント」を推定し，そこから外れている部分を注意喚起しています。


            ### 2. 判定の前提：ベースフォントの推定

            まず文書全体を走査し，次の優先順位で **「この文書のベースフォント」** を推定します。

            1. `Normal` / `本文` / `Body Text` など **本文スタイルの段落** に含まれるフォント
               - もっとも多く現れるフォントを「本文のベースフォント」と見なします。
            2. もし本文スタイルがほとんど使われていない場合は，
               **全体の run（文字列）の中で最頻のフォント** をベースフォントとします。

            また，同様に頻度から **ベースとなるフォントサイズ（pt）** も推定します。

            > ※ここでの「ベースフォント」はあくまで統計的な推定値です。
            > 文書によっては意図的に複数フォントを使い分けている場合もあるため，
            > 判定結果はあくまで「参考情報」としてご利用ください。


            ### 3. 段落ごとに行っているチェック

            各段落（Paragraph）について，run の情報から次のようなチェックを行います。

            #### (1) 段落内で複数フォントが混在しているか

            - 1つの段落の中で，**実効フォント名をセットにしたとき 2種類以上あるか** を判定します。
            - 実効フォントは，
              - run 自身のフォント指定
              - run のスタイルのフォント
              - 段落スタイルのフォント
              - Normal スタイルのフォント
              の順にたどって決定します。
            - 2種類以上ある場合は「**段落内で複数フォントが混在**」として注意を出します。

            典型的なケース：

            - 行の途中だけ Arial / 游ゴシック Light が紛れ込んでいる
            - コピー＆ペーストで別フォントが入り込んだ

            このような混在は，印刷や PDF 化したときに「なんとなく違和感のある行」になることが多いため，
            一覧にして確認できるようにしています。


            #### (2) 本文段落でベースフォント以外を使っていないか

            - スタイルが `Normal` / `本文` / `Body Text` の段落を **本文段落** とみなします。
            - その段落に含まれるフォントのうち，
              **推定ベースフォント以外のフォントが含まれている場合** に注意を出します。
            - 注意文では，
              - どの段落か（段落番号）
              - 段落のスタイル名
              - 段落内のフォント一覧
              - ベースフォントとの違い
              を日本語で説明します。

            目的：

            - 「本文は原則として一つのフォント・サイズで統一する」という
              レポート・報告書作成上の基本ルールを守れているかどうかを確認するためです。


            #### (3) 見出しらしいのに本文スタイルのままになっていないか

            - スタイルが `Normal` / `本文` / `Body Text` で，
            - かつ，次のような条件を満たす短い行を **「見出しらしい段落」** とみなします。
              - 文字数が 30 文字以内
              - 行頭が数字（「1」「2」など）で始まる
              - 行頭が「第」で始まる（例：第1章）
              - 行頭が括弧「（」「(」で始まる など

            こうした段落は，章・節番号付きの見出しであることが多いため，
            **本文用スタイルのままになっていると注意** を出します。

            - 「見出し1〜3」などの見出しスタイルを使うことで，
              - 自動目次
              - ナビゲーションウィンドウ
              - PDF のしおり
              などが利用できるようになります。

            > ※ここでの「見出しらしさ」の判定はあくまで簡易なヒューリスティックです。
            > 箇条書きやキャプションなどで誤判定される場合もあります。


            ### 4. 集計・参考情報として出しているもの

            このツールは，異常・注意箇所のほかに，次のような **全体の統計情報** も出します。

            #### (1) フォント別・文字数／段落数の集計

            - 各フォントごとに
              - そのフォントで書かれている文字数（おおよそ）
              - そのフォントが代表として使われている段落数
              を集計して一覧にします。
            - 文書全体で「たまたま数文字だけ使われたフォント」や
              「見出しだけ別フォントにしている」などの傾向を把握できます。

            #### (2) スタイル（段落スタイル）の使用状況

            - `Normal`, `Heading 1`, `見出し 1` など，各スタイルが **何回使われているか** を集計します。
            - これにより，
              - 見出しスタイルがほとんど使われていない
              - すべて Normal スタイルで書かれている
              などの傾向が一目で分かります。

            #### (3) 総文字数

            - 段落テキストの長さから **総文字数** を概算します。
            - 文書のボリューム感の把握や，他のレポートとの比較に使えます。


            ### 5. レポート出力の内容（Word / PDF）

            「レポートのダウンロード」から取得できる Word / PDF レポートには，概ね次の内容が含まれます。

            - ベースフォントとベースフォントサイズの推定結果
            - 総文字数
            - フォント別の文字数・段落数一覧
            - スタイル使用状況の一覧
            - 異常・注意箇所の一覧
              - **種類（日本語ラベル）**
              - **段落番号**
              - **スタイル名**
              - **フォント一覧**
              - **理由（なぜ注意として検出されたかの説明）**
              - **段落内容のプレビュー**

            これにより，「どこを直せば版面が整うか」「どこかおかしなスタイルの使い方をしていないか」を，
            Word を直接開きながら効率的に確認できるように設計しています。


            ### 6. 判定結果の位置づけ

            - このツールは **自動チェックの補助ツール** であり，
              - 校閲者や作成者が最終判断をするための「気付きの一覧」を提供することが目的です。
            - 「注意」と出ている箇所が **必ずしも誤りとは限りません**。
              - 意図的なデザイン（強調など）の場合もあります。
            - 逆に，「注意が出ていないから絶対に問題ない」という保証を与えるものでもありません。

            そのため，

            - 重要なレポート・論文では，
              1. このツールでゆらぎ候補を機械的に列挙
              2. 人間が文書を読みながら必要な箇所だけ修正

            という **「自動チェック＋目視チェック」の組み合わせ** を前提に使っていただくことを想定しています。
            """
        )
