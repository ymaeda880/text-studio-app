# -*- coding: utf-8 -*-
# lib/toc_check/explanation.py
#
# 目次チェックのロジックと使い方を説明する expander（Streamlit用）

from __future__ import annotations
import streamlit as st


def render_toc_logic_expander() -> None:
    """
    目次チェックツールのロジックと使い方の説明を expander で描画します。
    pages/22_目次チェック.py などから呼び出して使います。
    """
    with st.expander("ℹ️ このツールが拾う目次と頁番号のルール（クリックで展開）", expanded=False):
        st.markdown(
            """
            ## 1. このツールが行う処理（全体の流れ）

            1. PDF 全体からページごとのテキストを取得します。
            2. 先頭数ページから **目次候補（見出し＋頁番号）** を抽出します。
            3. 本文側では、各ページの「ページラベル」「本文テキスト」をまとめた  
               **segment（セグメント）** を作成します。
            4. ページラベルの連番・章番号・シリーズの妥当性を確認します。
            5. 目次候補を **行ごとに順番に** 本文へ照合し、  
               一致・候補・未検出といった情報を表として出力します。

            この処理では **AI は使用しておらず**、文字列ベースのルールに基づいて機械的に照合しています。

            ---

            ## 2. 目次候補（見出し＋頁番号）の抽出方法

            先頭の PDF テキストから `extract_toc_lines()` を使って、目次らしい行を抽出します。

            - デフォルトでは **先頭 10 ページを連結したテキスト** から抽出します。  
              （サイドバーの「目次抽出は冒頭10pを連結」で切り替え可能です）
            - 目次らしい行とは、  
              1. **行の先頭側が「目次っぽい書き出し」になっていること**  
              2. **行の末尾側に「頁番号らしいラベル」が付いていること**  
              の両方を満たす行です。

            ### 2-1. 行の先頭側のフィルタ（`head_ok` の条件）

            コード上では、次の正規表現で「目次の先頭らしい行」だけを候補にしています。

            ```python
            head_ok = re.compile(
                r"^\\s*(?:"
                r"序|資料|付録|第|添付資料|⚪︎|○|"
                r"[0-9０-９]|"
                r"\\[|［|"
                r"[（(][0-9０-９]{1,3}[）)]"
                r")"
            )
            ```

            これは、行頭（空白を無視）から見て、以下のいずれかで始まる行だけを「目次候補の可能性あり」とみなします。

            - **「序」**  
              - 例：`序  本報告書の構成`  
              - 序章・前書きのような項目を想定しています。
            - **「資料」**  
              - 例：`資料1  調査対象一覧`  
              - 巻末や後半にある資料リストを想定しています。
            - **「付録」**  
              - 例：`付録A  分析手法の詳細`  
              - Appendix / 付録の項目を想定しています。
            - **「第」**  
              - 例：`第1章  総論`、`第2節  分析結果`  
              - 「第◯章」「第◯節」といった典型的な章・節見出しを想定しています。
            - **「添付資料」**  
              - 例：`添付資料1  アンケート票`  
              - 添付資料一覧を目次に載せているケースを想定しています。
            - **丸印（⚪︎ / ○）で始まる行**  
              - 例：`○ 第1回会合の概要`  
              - 行頭の「○」を行番号・小項目の印として使っている目次を想定しています。
            - **半角または全角の数字で始まる行**（`[0-9０-９]`）  
              - 例：`1  はじめに`、`２−１  分析対象`  
              - 「1」「1-1」「2.3.1」など、数字で項目番号が始まる形式の目次を想定しています。
            - **角括弧で始まる行**（`[` または `［`）  
              - 例：`[1] はじめに`、`［資料1］ 調査票`  
              - 番号を角括弧で囲ったスタイルの目次見出しを想定しています。
            - **括弧＋数字で始まる行**（`（1）` や `(2)` など）  
              - 例：`(1) 調査の目的`、`（2） 調査の方法`  
              - 小項目番号を丸括弧付きの数字で表しているケースを想定しています。

            さらに、行全体に対して

            - **かな・漢字・アルファベットのいずれかの文字が含まれているか**  
              を別の正規表現 `text_char` で確認しています。  
              これにより、数字だけの行や罫線だけの行などを除外し、  
              「少なくとも何かしら本文テキストが書かれている行」に絞り込んでいます。

            この「先頭側のフィルタ」に通った行だけが、次の「末尾ラベル判定」に進みます。

            ### 2-2. 行の末尾側の「頁番号ラベル」の抽出ルール

            先頭側の条件をクリアした行について、次は  
            `LABEL_TAIL_RE`（`build_label_tail_regex_mixed()`）で **行末のラベル** を調べます。

            ここでは、次のようなパターンを「目次の頁番号ラベル」として拾います  
            （全角・半角は内部で正規化します）。

            1. **純粋な数字だけの場合**  
               - 例：`12`, `3`  
               - 「12 ページ」「3 ページ」といった単純な頁番号として扱います。

            2. **数字をハイフンでつないだ階層番号の場合**  
               - 例：`1-2`, `3-10-2`  
               - 章・節・項などの階層をハイフンで表したものとして扱います  
                 （全角数字・全角ハイフンも `z2h_numhy()` で正規化します）。

            3. **語＋数字（シリーズ番号）の場合**  
               - 例：`資料2`, `資料2-1`, `図表-3` など  
               - 日本語・アルファベット（`ALPHAJP`）＋ハイフン＋数字の組み合わせを  
                 「シリーズラベル＋番号」として扱います。

            4. **上記ラベルが括弧で囲まれている場合**  
               - 例：`(資料)12`, `（資料2-1）`  
               - 括弧は外側の装飾とみなし、中身の「資料ラベル＋数字」の部分をラベルとして利用します。

            これらの条件に合致した場合にだけ、

            - 行頭〜ラベル直前までを **目次タイトル**
            - 行末のラベル部分を **目次頁ラベル**

            として切り分け、`"タイトル ::: ラベル"` という形で `extract_toc_lines()` の結果に追加します。

            ---

            ## 3. 本文側のページラベルとセグメントの作成方法

            `build_segments()` は、各 PDF ページから次の情報を含む  
            **segment（ページ単位のまとまり）** を構築します。

            - `pdf_page` : PDF 上のページ番号（1, 2, 3, …）
            - `page_label` : 紙面上で検出したページラベル  
              （例：`12`, `3-2`, `資料2` などの単独行）
            - `body` : そのページの本文テキスト（`normalize_strict()` 済み）
            - `matched_line` : `page_label` を検出した元の行

            ページ下部のフッターなどにある **単独行のページ番号** を拾う前提の処理です。

            `validate_segments()` では、抽出した `page_label` を並べて次の点を確認します。

            - ページ番号が自然に増えているか（1 → 2 → 3 → …）
            - 章番号／シリーズ（例：3-1, 3-2, 3-3）が不自然に飛んでいないか
            - ラベルの重複や異常がないか

            結果は「📑 ページラベル検証」テーブルとして表示されます。

            ---

            ## 4. 目次と本文の照合ロジック（`check_toc_by_order`）

            `check_toc_by_order()` は、抽出した目次を **上から順番に** たどりながら  
            本文側のセグメントと照合します。

            照合に使用する情報は次のとおりです。

            - 目次側：タイトルテキスト、目次側の頁ラベル
            - 本文側：`seg_index`（ページラベル → pdf_page の対応）、本文テキスト

            処理の流れは次のようになっています。

            1. 目次行から「タイトル」と「目次頁ラベル」を抽出します。
            2. `seg_index` を参照して、その頁ラベルが指す PDF ページを探します。  
               - 見つかった場合：そのページ（＋前後ページ）の本文をスキャンします。
               - 見つからなかった場合：  
                 「未検出時に全ページ探索を行う」が ON の場合は、全文から探します。
            3. 本文側のスキャンでは、  
               **単独の1行** と **隣接2行を結合した窓（2行窓）** の両方で比較を行います。
            4. タイトルと一致、あるいは近似している行を検出し、  
               「一致テキスト行」として記録します。

            これらの結果を集計したものが「🔍 照合結果（行ベース）」テーブルです。  
            利用者の方は **「タイトル」「pdf頁」「判定」「一致テキスト行」** を確認することで、  
            どの目次項目がどのページのどの行に対応しているかを把握できます。

            ---

            ## 5. サイドバーオプションの意味

            ### ●「目次抽出は冒頭10pを連結」

            - **ON（デフォルト）**  
              - 先頭 10 ページを連結して目次候補を抽出します。  
              - 目次が複数ページに分かれている PDF に向いています。
            - **OFF**  
              - 1 ページ目だけから抽出します。  
              - 典型的な「1ページ目にだけ目次がある」PDF では高速です。

            ### ●「未検出時に全ページ探索も行う」

            - **ON** にすると、頁ラベルから該当ページが見つからない場合に  
              PDF 全ページを対象に再探索します。
            - **OFF** の場合は、該当ページが見つからなければその項目は「未検出」となります。  
              処理は高速です。

            ---

            ## 6. 結果の見方と注意点

            - このツールは **ルールベース（機械的照合）** のため、  
              PDF のレイアウト・改行・文字化けなどの影響を受けることがあります。
            - タイトル行がうまく拾えなかったり、  
              目次候補が抽出されない場合もあります。
            - 最終確認は、Excel 出力や画面上の結果を見ながら  
              **利用者の方が目視で確認することを前提** としています。

            それでも本ツールは、

            - 目次ページのずれ  
            - ページ番号の取り違え  
            - 目次に存在するのに本文では見つからない項目  

            といった **典型的なミスを短時間で発見する** のに有効です。
            """
        )
