# -*- coding: utf-8 -*-
# lib/word_analysis/explanation.py
#
# Word解析（中間テキスト生成）の利用者向け説明（Streamlit用）
# - pages/16_word解析（box対応）.py 等から呼び出す想定
# - 純粋な表示専用（状態・ロジックなし）
#
# 使い方：
#   from lib.word_analysis.explanation import render_word_analysis_help_expander
#   render_word_analysis_help_expander()

from __future__ import annotations
import streamlit as st


# ============================================================
# ✅ 文言定数（編集は基本ここだけ）
# ============================================================

HELP_EXPANDER_TITLE = "📌 説明（クリックで展開）"
# ★タブを追加：「サイドバーのオプション」
HELP_TABS = [
    "最初に",
    "出力スタイル/設定",
    "サイドバーのオプション",
    "ダウンロード",
    "Inbox保存",
    "注意/よくある質問",
]


# ============================================================
# ✅ 最初に
# ============================================================

INTRO_CAPTION = (
    "Word(.docx) を解析して，生成AIへ入力しやすい「中間テキスト」を1つ生成します．"
    "見出し・表・図を分離し，必要なら Inbox に保存して他ページで再利用できます．"
)

INTRO_MD = """
### 何をするページか

このページは，Word（.docx）の内部構造をざっくり解析して，

- **見出し**（章番号つき／または見出し候補括り）
- **本文**（プレーンテキスト）
- **表**（JSON埋め込み もしくは読みやすい簡素表記）
- **図**（キャプション＋画像ファイル名）

をまとめた **「中間テキスト」** を作ります．

---

### 典型的な使い方（おすすめ）

1. Word(.docx) をアップロード
2. 出力スタイル（簡素/標準/詳細）と base_chapter を選ぶ
3. 「解析して中間テキストを生成」を押す
4. 中間テキストを **ダウンロード** or **Inbox保存**
5. 後で「文章校正」ページの **📥 Inboxから** を使って再利用
"""




# ============================================================
# ✅ 出力スタイル / 設定（ヘルプ文）
# ============================================================
OPTIONS_MD = """

### 出力スタイル（簡素 / 標準 / 詳細）

この設定は、Word 文書を解析して生成する「中間テキスト」を、
**どの程度まで構造化して出力するか**を指定するものです。
後続の生成AI処理（要約・抽出・再構造化など）や Inbox 保存の運用に応じて選択してください。

#### 簡素（simple）
- できるだけプレーンなテキストに近い形で出力します（人が読みやすいことを優先）。
- 見出し・表・図は、`<ここから〜>` / `<ここまで〜>` のような **最小限の区切り**だけを使います。
- 見出しは「章番号付きID」や `HEADING[...]` 形式にはせず、**見出し本文そのもの**を出力します。
- 図は「図であること」を強く主張せず、**キャプションがあればそれだけを1行で出す**方針です（画像ファイル名は出しません）。
- 表は JSON 化せず、`<ここから表>`〜`<ここまで表>` の間に **各行を1行テキスト（[a, b, c] 形式）**で並べます。
- 「AIに投げる前に軽く整えたい」「人が目視で確認したい」「マーカーが多いと読みにくい」場合に向いています。

#### 標準（standard）
- 実運用で最もバランスが良い“おすすめ”モードです（分割保存とも相性が良い）。
- 見出し候補を `<ここから見出し>`〜`<ここまで見出し>` で明示的に括ります。
  - Word 側で「見出しスタイル」が本文に誤って使われている場合でも、
    句読点がない・1行・長さが適切、といった条件を満たす **“見出しらしい短い行だけ”を見出し扱い**にするため、
    見出し誤検出で本文が大量に見出し化される事故を避けられます。
  - 逆に、見出しっぽくない行は **本文としてそのまま出力**します（見出しマーカーを付けません）。
- 図は `<ここから図>`〜`<ここまで図>` で括り、対応する画像を `image_files: ...` として併記します。
  - 画像が見つからない場合は `image_files: (none)` を出します（後工程での判断材料になります）。
- 表は `<ここから表>`〜`<ここまで表>` の間に **各行を1行テキスト（[a, b, c] 形式）**で並べます（人が追いやすい形式）。
- **Inbox への分割保存**では、`<ここから見出し>` の直前を切れ目として分割するため、
  構造を保ったまま「章（または節）単位のチャンク」に近い形で保存しやすくなります。

#### 詳細（detailed）
- 後段で機械処理しやすいように、見出し・図・表へ **明示的なマーカー**を付けて出力します。
  - 見出し：`=== HEADING[章-節-項] タイトル ===`
  - 図：`=== FIGURE[n] キャプション ===` ＋ `image_files: ...`
  - 表：`=== TABLE ... ===` 〜 `=== END_TABLE ===` の間に JSON を埋め込み
- 見出しには章番号付きIDが付与され、文書構造がより厳密に表現されます（後段で「見出し単位に抽出/要約」しやすい）。
- 表は JSON を埋め込む形式が基本で、表データの再利用（抽出・整形・再描画）やプログラム処理に強いです。
- 構造情報を正確に保持したい場合や、AI処理を前提とした高度な後工程がある場合に向いています。

---

### base_chapter（章番号）
- 見出しIDの先頭に付与する章番号です（例：3 → `HEADING[3-1-2]`）。
- Word 文書が「第3章」「第4章」といった構成の場合、その章番号に合わせて指定すると、
  後段の参照（どの章のテキストか）や分割・再解析が分かりやすくなります。

---

### 結合セルの扱い（表）
- 横方向に結合されているセルを `<同左>` で補完するオプションです。
- 表の構造解釈を安定させたい場合（特に横結合が多い文書）に有効です。

---

### Inbox送信用 分割上限（文字数）
- 中間テキストを Inbox に保存する際、**1ファイルが大きくなりすぎないように自動分割**するための上限です。
- 分割は、可能な限り `<ここから見出し>` の直前を切れ目として行われます（標準モード推奨の理由のひとつです）。
- 目安は 30,000 文字前後ですが、文書の長さ・後段AIの投入量・運用（1件あたりの扱いやすさ）に合わせて調整してください。

""".strip()


# ============================================================
# ✅ サイドバーのオプション（詳細解説）
# ============================================================

SIDEBAR_OPTIONS_MD = """
### サイドバーのオプション（何を設定しているか）

このページのサイドバーは、**中間テキストの出力方法**と、**表の扱い**と、**Inbox保存時の分割**を決めるための設定です。
迷った場合は、まずは「標準」を選び、必要に応じて調整してください。

---

#### 1) 出力スタイル（簡素 / 標準 / 詳細）
中間テキストを **どれだけ構造化して出すか**を決めます。

- **簡素（simple）**：プレーン寄り。人が読む用途や、軽い前処理に向きます。  
- **標準（standard）**：見出し候補・図・表を `<ここから〜>` で括って分かりやすくします。  
  特に見出しは、Wordの「見出しスタイル誤用」に強く、分割保存の切れ目（見出し直前）も作りやすいので、基本推奨です。  
- **詳細（detailed）**：`=== HEADING[...] ===` などの明示マーカーを付け、表は JSON を埋め込むため、後段の機械処理に強いです。

※ 「出力スタイル」そのものの出力例や違いは、上の「出力スタイル/設定」タブにまとめています。

---

#### 2) この章の章番号（base_chapter）
見出しに付与する「章番号」です。

- **詳細（detailed）モード**では、見出しが `HEADING[3-1-2]` のような **章番号付きID**で出力されます。  
  ここで指定した `base_chapter` が、先頭の `3` に入ります。
- Wordが「第3章」「第4章」…のように章単位で構成されている場合は、処理対象の章番号に合わせて指定すると、後段の参照が楽になります。

補足：見出し検出について  
- 見出しスタイル（Heading 1〜 / 見出し 1〜）の段落だけでなく、  
  「第◯章」「◯◯の状況」などの **短く独立したラベル行**が見出しとして扱われることがあります。  
- 標準（standard）では、見出しスタイルが誤用されていても「見出しらしい短い1行」だけを見出しとして括る設計です。

---

#### 3) 結合セルの扱い（そのまま / 横結合セルを <同左> にする）
Wordの表にはセル結合があり、特に **横方向（列方向）の結合**があると、表を行列に落としたときに空セルが出たり、列対応が崩れがちです。

- **そのまま**：Wordの見た目に近いまま取り出します（結合の影響で空セルが残ることがあります）。  
- **横結合セルを `<同左>` にする**：横結合の影響で空になったセルを `<同左>` で補完します。  
  これにより「このセルは左のセルの続き（結合の範囲内）」という情報が残り、後段で表構造を解釈しやすくなります。

おすすめの目安：
- 見出し行やカテゴリ名が結合セルで表現される表が多い文書 → `<同左>` を有効にすると安定しやすい  
- 結合が少ない表中心 → どちらでも大きな差は出にくい

---

#### 4) 📏 Inbox送信用 分割上限（文字数）
中間テキストを Inbox に保存するとき、**1ファイルが大きくなりすぎないように分割**する上限です。

- 分割は、可能な限り **`<ここから見出し>` の直前**を切れ目として行います。  
  そのため、標準（standard）で見出し括りが付くと、章・節単位に近いチャンクに分けやすくなります。
- もし `<ここから見出し>` が無い（＝見出し括りが無い）場合は、フォールバックとして固定長で分割します。
- 目安は 30,000 文字前後ですが、後段の処理（AI投入量やUIの扱いやすさ）に合わせて調整してください。

---

#### 迷ったときのおすすめ設定
- 出力スタイル：**標準**
- base_chapter：処理対象の章番号に合わせる（不明なら 1）
- 結合セル：横結合が多い表があるなら **`<同左>` を有効**
- 分割上限：まずは **30,000 文字**（長い章なら下げる）
""".strip()



# ============================================================
# ✅ ダウンロード
# ============================================================

DOWNLOAD_MD = """
### ダウンロードできるもの

#### 1) 中間テキスト（.txt）
- 生成された中間テキストをテキストファイルとして保存します
- そのまま生成AIに入力したり，他ページへ渡す用途に使います

#### 2) 画像ZIP（.zip）
- Word内の画像（`/word/media/imageX.png` 相当）を ZIP にまとめて保存します
- 図のキャプションと画像を照合する，別ツールで図を扱う，などに便利です
"""


# ============================================================
# ✅ Inbox保存
# ============================================================

INBOX_MD = """
### 📥 中間テキストを Inbox に保存（おすすめ運用）

作った中間テキストは，**Inbox（ファイル置き場）に保存**しておくと再利用が簡単です．  
特に「文章校正」ページでは，入力方法の **📥 Inboxから** で読み込めます．

---

#### 手順

1. 「📥 中間テキストを Inbox へ保存」までスクロール
2. 保存ファイル名（.txt）を確認（必要なら変更）
3. 「📥 中間テキストを Inbox に保存」を押す

---

### 分割保存の仕様（長文対策）

#### 分割の考え方
- 中間テキストが長い場合，1ファイルのままだと扱いにくいことがあります
- このページでは **「見出しの直前」で切る**ことを基本にして，
  1ファイルが指定文字数を超えないように分割できます（標準モードと相性が良い）

#### 分割ルール
- **`<ここから見出し>` がある場合**：
  - `<ここから見出し>` の直前を「切れ目候補」にして，
    上限文字数以内になるように束ねて分割します
- **`<ここから見出し>` が無い場合**：
  - フォールバックとして固定長で単純分割します

#### ファイル名
- 分割が 1 件なら：指定名のまま保存
- 分割が複数なら：`_part001`, `_part002` … の連番が付きます  
  例）`xxx.txt` → `xxx_part001.txt`, `xxx_part002.txt`, ...

---

### よくある保存エラー

- Inbox が見つからない：ストレージ接続や設定を確認してください
- 容量上限超過：不要ファイルを削除するか，分割上限を小さくして試してください
- 保存失敗：一時的な障害の可能性があるので，再実行してください
"""


# ============================================================
# ✅ 注意 / FAQ
# ============================================================

FAQ_MD = """
### 注意点

- このページは **Word(.docx) 専用**です（PDFは対象外）
- 解析は「ざっくり構造化」です：
  - Wordの作りやスタイル設定次第で，見出し/本文の境界が完全一致しないことがあります
  - その場合は **出力スタイル**（標準/詳細）を変えると改善することがあります

---

### よくある質問

#### Q. どの出力スタイルが良い？
- 迷ったら **標準**がおすすめです
- 表を後で再利用したい（JSONで扱いたい）なら **詳細**
- とにかくプレーンに近くしたいなら **簡素**

#### Q. Inbox保存は必須？
- 必須ではありません（ダウンロードだけでもOK）
- ただし運用上は，後で「文章校正」等に渡すなら **Inbox保存が楽**です

#### Q. 分割はいつ使う？
- 長いWord（章が大きい/図表が多い/表JSONが大きい）で，
  後工程が重いと感じたら分割がおすすめです
"""


# ============================================================
# ✅ 公開API：説明UI（expander + tabs）
# ============================================================

def render_word_analysis_help_expander() -> None:
    """
    Word解析ページ向けの説明UIを 1つの expander に統合し、tabs で切り替える。
    - 純粋な表示専用（状態・ロジックなし）
    - pages 側では 1 行呼ぶだけ
    """
    with st.expander(HELP_EXPANDER_TITLE, expanded=False):
        (
            tab_intro,
            tab_options,
            tab_sidebar,
            tab_dl,
            tab_inbox,
            tab_faq,
        ) = st.tabs(HELP_TABS)

        with tab_intro:
            _render_tab_intro()

        with tab_options:
            _render_tab_options()

        with tab_sidebar:
            _render_tab_sidebar_options()

        with tab_dl:
            _render_tab_download()

        with tab_inbox:
            _render_tab_inbox()

        with tab_faq:
            _render_tab_faq()


# ============================================================
# ✅ タブ描画（表示だけ）
# ============================================================

def _render_tab_intro() -> None:
    st.caption(INTRO_CAPTION)
    st.markdown(INTRO_MD)


def _render_tab_options() -> None:
    st.markdown(OPTIONS_MD)


def _render_tab_sidebar_options() -> None:
    st.markdown(SIDEBAR_OPTIONS_MD)


def _render_tab_download() -> None:
    st.markdown(DOWNLOAD_MD)


def _render_tab_inbox() -> None:
    st.markdown(INBOX_MD)


def _render_tab_faq() -> None:
    st.markdown(FAQ_MD)
